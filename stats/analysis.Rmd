---
title: "Stats"
author: "Julia Prein"
date: "03/21/2023"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_packages, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse) # data handling etc.
library(viridis) # col scales, plotting...
library(ggpubr)
library(ggthemes)
library(tidyboot) # for bootstrap CIs
library(brms) # modeling
library(tidybayes) # for stat_halfeye

options(scipen = 999)
theme_set(theme_classic())

# Seed for random number generation
set.seed(42)
```

```{r load_data}
tango_lifespan <- readRDS("../data/tango-lifespan.rds")
tango_model <- readRDS("../data/tango-model.rds")
magnet <- readRDS("../data/magnet-data.rds")
```

# DEVELOPMENTAL TRAJECTORY
```{r lifespan_sample}
lifespan_sample <- tango_lifespan %>% 
  group_by(age_group) %>%
  mutate(female = ifelse(gender == "f", 1, 0)) %>% 
  summarise(
    n_total = n_distinct(subj_id), 
    age_mean = mean(age, na.rm = T) %>% round(2),
    age_sd = sd(age, na.rm = T) %>% round(2),
    age_min = min(age, na.rm = T),
    age_max = max(age, na.rm = T),
    n_females = ceiling(sum(female/15)),
  )
```

```{r variation_preparateData}
lifespan_variation <- tango_lifespan %>% 
  group_by(subj_id, age, age_group) %>%
  summarise(mean = mean(click_dist_balloons, na.rm = TRUE))
```


```{r lifespan_plot}
ggplot(data = lifespan_variation, aes(x = age, y = mean)) +
  geom_point(color = "darkgrey", alpha = 0.5) +
  geom_smooth(method = "loess", size = 1, se = T, color = "#006c66", fill = "#006c66") + 
  scale_x_continuous(limits = c(0, 80), breaks = seq(0, 80, 5)) + 
  scale_y_continuous(limits = c(0, 4), breaks = seq(0, 4, 0.5)) + 
  labs(x = "Age in years", y = "Average imprecision in target widths") 
  
ggsave("../figures/tango_lifespan.png", width = 8, height = 4, scale = 1.2)
```

```{r lifespan_model}
mDataLifespan <- tango_lifespan %>% 
  mutate(
    symmetric_position = scale(symmetric_position),
    trial_nr = trial_nr - min(trial_nr), 
    click_dist = abs(click_dist_from_target_center_x),
  ) %>% 
  select(subj_id, age, age_centered, symmetric_position, trial_nr, click_dist, click_dist_balloons)

mLifespanNull <- brm(click_dist_balloons ~ age_centered + symmetric_position + trial_nr + (1 + symmetric_position + trial_nr | subj_id),
                    data = mDataLifespan,
                    family = lognormal(),
                    warmup = 1000, 
                    iter   = 3000, 
                    chains = 4, 
                    inits  = "random",
                    cores  = 4)


write.csv(mAgeHedge, "../saves/mLifespan.csv", quote = F, row.names = F)
saveRDS(mAgeHedge, "../saves/mLifespan.rds")
```

# COGNITIVE MODEL

```{r gazefunnel}
target_position_impr <- tango_model %>% 
  group_by(age_group, target_position) %>% 
  tidyboot_mean(column = click_dist_balloons, na.rm = TRUE) 

target_position_impr_ind <- tango_model %>% 
  group_by(subj_id, age_group, target_position) %>% 
  tidyboot_mean(column = click_dist_balloons, na.rm = TRUE) 

ggplot() +
  geom_point(data = target_position_impr_ind, aes(x = target_position, y = mean, col = as.factor(age_group)), alpha = .1, position = position_dodge(width = 0.3)) +
  
  geom_pointrange(data = target_position_impr, aes(x = target_position, y = mean, ymin = ci_lower, ymax = ci_upper, col = as.factor(age_group)), pch = 18,  size = 1, position = position_dodge(width = .3)) + 
  
  scale_y_continuous(limits = c(0, 7), breaks = seq(0, 7, 1)) + 
  scale_color_manual(values = c("#c6d325", "#00b1ea", "#29485d"), breaks = c("3", "4", "5"), labels = c("3-year-olds", "4-year-olds", "5-year-olds")) +
    labs(x = "Target position (binned)", y = "Average imprecision in target widths", col = "Age in years")

ggsave("../figures/tango_gazefunnel.png", width = 6, height = 4, scale = 1.2)
```

